import asyncio
import pytest
from querent.common.types.querent_event import EventState, EventType
from querent.config.core.relation_config import RelationshipExtractorConfig
from querent.core.transformers.relationship_extraction_llm import RelationExtractor
@pytest.mark.asyncio
@pytest.mark.parametrize("input_data, expected_relationships", [
    (
        
        [('tectonic', '{"context": "In this study, we present evidence of a Paleocene\\u2013Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accom- modation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sedi- ment supply during the PETM, which is archived as a particularly thick sedimentary section in the deep-sea fans of the GoM basin.", "entity1_score": 1.0, "entity2_score": 1.0, "entity1_label": "B-GeoPetro", "entity2_label": "B-GeoMeth", "entity1_nn_chunk": "tectonic perturbations", "entity2_nn_chunk": "the upstream North American catchments", "file_path": "dummy_1_file.txt", "entity1_attnscore": 0.25, "entity2_attnscore": 0.11, "pair_attnscore": 0.15, "entity1_embedding": [3.9851672649383545, 5.444354057312012, 12.452054023742676, 0.40023085474967957, 5.477858543395996, -3.328960418701172, 7.499555587768555, -0.6432888507843018, 0.176153764128685, 4.574844837188721], "entity2_embedding": [3.910417318344116, 4.3172736167907715, 10.927567481994629, -0.4440983533859253, 5.645864009857178, -3.3608360290527344, 6.031068325042725, -0.13075894117355347, 1.19158935546875, 4.028927803039551], "sentence_embedding": [10.228797912597656, 0.9078602194786072, 3.8210675716400146, 2.9826271533966064, -1.7877899408340454, 9.019113540649414, 7.322807788848877, 0.4493107795715332, 5.830756187438965, 5.221020698547363]}', 'upstream'), ('basin', '{"context": "We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accom- modation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sedi- ment supply during the PETM, which is archived as a particularly thick sedimentary section in the deep-sea fans of the GoM basin.", "entity1_score": 1.0, "entity2_score": 1.0, "entity1_label": "B-GeoPetro", "entity2_label": "B-GeoMeth", "entity1_nn_chunk": "the GoM basin", "entity2_nn_chunk": "upstream", "file_path": "dummy_1_file.txt", "entity1_attnscore": 0.26, "entity2_attnscore": 0.09, "pair_attnscore": 0.13, "entity1_embedding": [3.031496524810791, 5.5543012619018555, 12.802851676940918, -0.40406331419944763, 5.433542251586914, -4.073908805847168, 7.429781436920166, -0.35669469833374023, 1.03021240234375, 5.3818559646606445], "entity2_embedding": [3.7557637691497803, 4.355807781219482, 10.816529273986816, -0.5670130848884583, 5.616918087005615, -3.3334271907806396, 5.912326335906982, -0.06841135025024414, 1.1116150617599487, 4.205568790435791], "sentence_embedding": [9.40550708770752, 1.8712570667266846, 4.63387393951416, 3.8367974758148193, -1.094395637512207, 8.434747695922852, 6.475388050079346, 1.6503015756607056, 5.695371150970459, 5.418364524841309]}', 'upstream'), ('deposition', '{"context": "We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accom- modation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sedi- ment supply during the PETM, which is archived as a particularly thick sedimentary section in the deep-sea fans of the GoM basin.", "entity1_score": 1.0, "entity2_score": 1.0, "entity1_label": "B-GeoPetro", "entity2_label": "B-GeoMeth", "entity1_nn_chunk": "deposition", "entity2_nn_chunk": "upstream", "file_path": "dummy_1_file.txt", "entity1_attnscore": 0.26, "entity2_attnscore": 0.09, "pair_attnscore": 0.13, "entity1_embedding": [3.6060078144073486, 6.190525531768799, 12.511820793151855, 0.2952989339828491, 5.2114458084106445, -3.542228937149048, 7.520601272583008, -0.6833171844482422, 0.31914183497428894, 4.374380588531494], "entity2_embedding": [3.9278876781463623, 4.369570255279541, 10.83134651184082, -0.3810097873210907, 5.6381611824035645, -3.3257150650024414, 6.1031060218811035, -0.1740904599428177, 0.879339873790741, 3.5072436332702637], "sentence_embedding": [9.471346855163574, 1.8663707971572876, 4.568644046783447, 3.7678043842315674, -0.9877296090126038, 8.311663627624512, 6.345090389251709, 1.6819571256637573, 5.708926677703857, 5.485371112823486]}', 'upstream')
        
        ],
        
        [
            ('tectonic', '{"context": "study , present evidence paleocene\\u2013eocene thermal maximum ( petm ) record within 543-m-thick ( 1780 ft ) deep-marine section gulf mexico ( gom ) using organic carbon stable isotope biostratigraphic constraint . suggest climate tectonic perturbation upstream north american catchment induce substantial response downstream sector gulf coastal plain ultimately gom . relationship illustrated deep-water basin ( 1 ) high accom- modation deposition shale interval coarse-grained terrigenous material wa trapped upstream onset petm , ( 2 ) considerable increase sedi- ment supply petm , archived particularly thick sedimentary section deep-sea fan gom basin .", "entity1_nn_chunk": "tectonic perturbations", "entity2_nn_chunk": "the upstream North American catchments", "entity1_label": "B-GeoPetro", "entity2_label": "B-GeoMeth", "relationship": "1. Tectonic perturbation upstream North American catchment may have induced a substantial response downstream in the Gulf Coastal Plain, ultimately affecting the GOM deep-water basin.\\n            2. The increase in sediment supply during the PETM may have been archived in particularly thick sedimentary sections of the deep-sea fan in the GOM basin."}', 'upstream'),
            ('basin', '{"context": "suggest climate tectonic perturbation upstream north american catchment induce substantial response downstream sector gulf coastal plain ultimately gom . relationship illustrated deep-water basin ( 1 ) high accom- modation deposition shale interval coarse-grained terrigenous material wa trapped upstream onset petm , ( 2 ) considerable increase sedi- ment supply petm , archived particularly thick sedimentary section deep-sea fan gom basin .", "entity1_nn_chunk": "the GoM basin", "entity2_nn_chunk": "upstream", "entity1_label": "B-GeoPetro", "entity2_label": "B-GeoMeth", "relationship": "1. High accommodation deposition shale interval coarse-grained terrigenous material was trapped upstream during the onset of PETM, indicating a significant increase in sediment supply from the upstream North American catchment.\\n            2. The substantial response downstream in the Gulf Coastal Plain suggests that climate and tectonic perturbations upstream in the North American catchment had a profound impact on the GOM basin."}', 'upstream')
        ]
    ),
])

async def test_relationship_extraction(input_data, expected_relationships):
    mock_config = RelationshipExtractorConfig()  
    output = await RelationExtractor(mock_config).process_event(EventState(EventType.NER_GRAPH_UPDATE, 1.0, input_data))
    assert expected_relationships[0][0] in output[0]

