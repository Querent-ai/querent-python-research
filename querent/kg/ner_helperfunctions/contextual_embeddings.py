from querent.kg.ner_helperfunctions.ner_llm_transformer import NER_LLM
from querent.logging.logger import setup_logger
import torch
import umap
import numpy as np
import time
import psutil

def get_memory():
    process = psutil.Process()
    return process.memory_info().rss / (1024 * 1024)  # Memory in MB

"""
    EntityEmbeddingExtractor: A class designed to extract embeddings for entities within a given context.

    Attributes:
        model (torch.nn.Module): A pre-trained model used for generating embeddings.
        tokenizer (Tokenizer): A tokenizer compatible with the model for tokenizing input text.
        reducer (umap.UMAP): A UMAP reducer for dimensionality reduction of embeddings.
        logger (logging.Logger): Logger for capturing and reporting errors.

    Methods:
        setup_logger() -> logging.Logger:
            Sets up a logger for the class.
        
        extract_entity_embedding(entity: str, context: str) -> torch.Tensor:
            Extracts the combined embedding of an entity and its context.
        
        fit_umap(all_embeddings: List[List[float]]):
            Fits the UMAP reducer on the collected embeddings.
        
        extract_and_append_entity_embeddings(doc_entity_pairs: List[Tuple[str, str, str, Dict[str, Any]]]) -> List[List[Tuple[str, str, str, Dict[str, Any]]]]:
            Extracts embeddings for entities in the provided document-entity pairs and appends them to the pairs.
    """

class EntityEmbeddingExtractor:

    def __init__(self, model, tokenizer):
        self.logger = setup_logger(__name__, "EntityEmbeddingExtractor")
        try:
            self.model = model
            self.tokenizer = tokenizer
        except Exception as e:
            self.logger.error(f"Error Initializing Entity Embedding Extractor Class: {e}")

    def extract_entity_embedding(self, entity, context):
        try:
            
            inputs = self.tokenizer(context, return_tensors="pt", truncation=True, padding=True, max_length=512)
            with torch.no_grad():
                outputs = self.model(**inputs, output_hidden_states=True)
                all_hidden_states = outputs.hidden_states  # Tuple of hidden states at each layer
                last_hidden_state = all_hidden_states[-1][0]  # Take the last layer's hidden state
            entity_token_ids = self.tokenizer.encode(entity, add_special_tokens=False)
            entity_positions = [i for i, token_id in enumerate(inputs["input_ids"][0]) if token_id in entity_token_ids]
            entity_embedding = last_hidden_state[entity_positions].mean(dim=0)
            sentence_embedding = last_hidden_state.mean(dim=0)
            combined_embedding = torch.cat((entity_embedding, sentence_embedding), dim=0)

            return combined_embedding, sentence_embedding
        
        except Exception as e:
            self.logger.error(f"Error extracting entity embedding: {e}")
            raise   Exception("Error extracting entity embedding: {}".format(e))

    
    def _get_relevant_context(self, entity1, entity2, full_context):
        sentences = NER_LLM.split_into_sentences(full_context)
        for sentence in sentences:
            if entity1.lower() in sentence.lower() and entity2.lower() in sentence.lower():
                return sentence
        return full_context
    
            

    def extract_and_append_entity_embeddings(self, doc_entity_pairs):
        try:
            start_time = time.time()
            start_memory = get_memory()
            for inner_list_index, inner_list in enumerate(doc_entity_pairs):
                to_remove = []  # List to hold indices of pairs to remove
                for pair_index, pair in enumerate(inner_list):
                    entity1, full_context, entity2, pair_dict = pair
                    context = self._get_relevant_context(entity1, entity2, full_context)
                    entity1_embedding, _ = self.extract_entity_embedding(entity1, context)
                    entity2_embedding, _ = self.extract_entity_embedding(entity2, context)

                    is_nan_entity1 = np.isnan(entity1_embedding).any()
                    is_nan_entity2 = np.isnan(entity2_embedding).any()

                    if is_nan_entity1 or is_nan_entity2:
                        # Record the index of the pair that needs to be removed
                        to_remove.append(pair_index)

                    if not is_nan_entity1:
                        pair_dict['entity1_embedding'] = entity1_embedding.tolist()
                    else:
                        print(f"NaN found in entity1: {entity1}")

                    if not is_nan_entity2:
                        pair_dict['entity2_embedding'] = entity2_embedding.tolist()
                    else:
                        print(f"NaN found in entity2: {entity2}")

                # Remove pairs with NaN embeddings from the inner list
                doc_entity_pairs[inner_list_index] = [pair for i, pair in enumerate(inner_list) if i not in to_remove]

            end_time = time.time()
            end_memory = get_memory()
            print(f"extract_entity_embedding 1 : Time elapsed: {end_time - start_time} seconds, Memory: {end_memory - start_memory} MB")
            return doc_entity_pairs
        
        except Exception as e:
            self.logger.error(f"Error extracting and appending entity embedding: {e}")
            raise Exception(f"Error extracting and appending entity embedding: {e}")


from transformers import AutoModel, AutoModelForTokenClassification,AutoTokenizer
def main():    
    data = [[('eocene', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM.', 'ft', {'entity1_score': 1.0, 'entity2_score': 0.69, 'entity1_label': 'B-GeoTime', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'a Paleocene–Eocene Thermal Maximum (PETM) record', 'entity2_nn_chunk': 'a 543-m-thick (1780 ft) deep-marine section', 'entity1_attnscore': 0.2, 'entity2_attnscore': 0.09, 'pair_attnscore': 0.12}), ('ft', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM.', 'mexico', {'entity1_score': 0.69, 'entity2_score': 0.92, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoLoc', 'entity1_nn_chunk': 'a 543-m-thick (1780 ft) deep-marine section', 'entity2_nn_chunk': 'Mexico', 'entity1_attnscore': 0.09, 'entity2_attnscore': 0.09, 'pair_attnscore': 0.09}), ('ft', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM.', 'organic', {'entity1_score': 0.69, 'entity2_score': 1.0, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a 543-m-thick (1780 ft) deep-marine section', 'entity2_nn_chunk': 'organic carbon stable isotopes', 'entity1_attnscore': 0.09, 'entity2_attnscore': 0.21, 'pair_attnscore': 0.12}), ('mexico', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM.', 'organic', {'entity1_score': 0.92, 'entity2_score': 1.0, 'entity1_label': 'B-GeoLoc', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'Mexico', 'entity2_nn_chunk': 'organic carbon stable isotopes', 'entity1_attnscore': 0.09, 'entity2_attnscore': 0.21, 'pair_attnscore': 0.13}), ('organic', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM.', 'isotopes', {'entity1_score': 1.0, 'entity2_score': 0.96, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'organic carbon stable isotopes', 'entity2_nn_chunk': 'organic carbon stable isotopes', 'entity1_attnscore': 0.21, 'entity2_attnscore': 0.37, 'pair_attnscore': 0.27})], [('tectonic', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin.', 'upstream', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'tectonic perturbations', 'entity2_nn_chunk': 'the upstream North American catchments', 'entity1_attnscore': 0.25, 'entity2_attnscore': 0.11, 'pair_attnscore': 0.15}), ('tectonic', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin.', 'downstream', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'tectonic perturbations', 'entity2_nn_chunk': 'the downstream sectors', 'entity1_attnscore': 0.25, 'entity2_attnscore': 0.49, 'pair_attnscore': 0.33}), ('upstream', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin.', 'downstream', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the upstream North American catchments', 'entity2_nn_chunk': 'the downstream sectors', 'entity1_attnscore': 0.11, 'entity2_attnscore': 0.49, 'pair_attnscore': 0.18}), ('upstream', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin.', 'coastal', {'entity1_score': 1.0, 'entity2_score': 0.98, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the upstream North American catchments', 'entity2_nn_chunk': 'the Gulf Coastal Plain', 'entity1_attnscore': 0.11, 'entity2_attnscore': 0.24, 'pair_attnscore': 0.15}), ('downstream', 'In this study, we present evidence of a Paleocene–Eocene Thermal Maximum (PETM) record within a 543-m-thick (1780 ft) deep-marine section in the Gulf of Mexico (GoM) using organic carbon stable isotopes and biostratigraphic constraints. We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin.', 'coastal', {'entity1_score': 1.0, 'entity2_score': 0.98, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the downstream sectors', 'entity2_nn_chunk': 'the Gulf Coastal Plain', 'entity1_attnscore': 0.49, 'entity2_attnscore': 0.24, 'pair_attnscore': 0.32})], [('basin', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'deposition', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the GoM basin', 'entity2_nn_chunk': 'deposition', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.27, 'pair_attnscore': 0.27}), ('basin', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'shale', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the GoM basin', 'entity2_nn_chunk': 'a shale interval', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.09, 'pair_attnscore': 0.14}), ('basin', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'coarse', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the GoM basin', 'entity2_nn_chunk': 'coarse-grained terrigenous material', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.06, 'pair_attnscore': 0.1}), ('deposition', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'shale', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'deposition', 'entity2_nn_chunk': 'a shale interval', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.09, 'pair_attnscore': 0.14}), ('deposition', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'coarse', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'deposition', 'entity2_nn_chunk': 'coarse-grained terrigenous material', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.06, 'pair_attnscore': 0.1}), ('deposition', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'upstream', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'deposition', 'entity2_nn_chunk': 'upstream', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.1, 'pair_attnscore': 0.14}), ('shale', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'coarse', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a shale interval', 'entity2_nn_chunk': 'coarse-grained terrigenous material', 'entity1_attnscore': 0.09, 'entity2_attnscore': 0.06, 'pair_attnscore': 0.07}), ('shale', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'upstream', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'a shale interval', 'entity2_nn_chunk': 'upstream', 'entity1_attnscore': 0.09, 'entity2_attnscore': 0.1, 'pair_attnscore': 0.09}), ('coarse', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'grained', {'entity1_score': 1.0, 'entity2_score': 0.99, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'coarse-grained terrigenous material', 'entity2_nn_chunk': 'coarse-grained terrigenous material', 'entity1_attnscore': 0.06, 'entity2_attnscore': 0.13, 'pair_attnscore': 0.08}), ('coarse', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'upstream', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'coarse-grained terrigenous material', 'entity2_nn_chunk': 'upstream', 'entity1_attnscore': 0.06, 'entity2_attnscore': 0.1, 'pair_attnscore': 0.07}), ('coarse', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'sediment', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'coarse-grained terrigenous material', 'entity2_nn_chunk': 'a particularly thick sedimentary section', 'entity1_attnscore': 0.06, 'entity2_attnscore': 0.32, 'pair_attnscore': 0.1}), ('upstream', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'sediment', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'upstream', 'entity2_nn_chunk': 'a particularly thick sedimentary section', 'entity1_attnscore': 0.1, 'entity2_attnscore': 0.32, 'pair_attnscore': 0.15}), ('upstream', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'pet', {'entity1_score': 1.0, 'entity2_score': 0.61, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'upstream', 'entity2_nn_chunk': 'the PETM', 'entity1_attnscore': 0.1, 'entity2_attnscore': 0.07, 'pair_attnscore': 0.08}), ('sediment', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'pet', {'entity1_score': 1.0, 'entity2_score': 0.61, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a particularly thick sedimentary section', 'entity2_nn_chunk': 'the PETM', 'entity1_attnscore': 0.32, 'entity2_attnscore': 0.07, 'pair_attnscore': 0.11}), ('sediment', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'sedimentary', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a particularly thick sedimentary section', 'entity2_nn_chunk': 'a particularly thick sedimentary section', 'entity1_attnscore': 0.32, 'entity2_attnscore': 0.12, 'pair_attnscore': 0.18}), ('sediment', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'sea', {'entity1_score': 1.0, 'entity2_score': 0.83, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a particularly thick sedimentary section', 'entity2_nn_chunk': 'the deep-sea fans', 'entity1_attnscore': 0.32, 'entity2_attnscore': 0.07, 'pair_attnscore': 0.11}), ('pet', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'sedimentary', {'entity1_score': 0.61, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the PETM', 'entity2_nn_chunk': 'a particularly thick sedimentary section', 'entity1_attnscore': 0.07, 'entity2_attnscore': 0.12, 'pair_attnscore': 0.09}), ('pet', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'sea', {'entity1_score': 0.61, 'entity2_score': 0.83, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the PETM', 'entity2_nn_chunk': 'the deep-sea fans', 'entity1_attnscore': 0.07, 'entity2_attnscore': 0.07, 'pair_attnscore': 0.07}), ('sedimentary', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'basin', {'entity1_score': 1.0, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a particularly thick sedimentary section', 'entity2_nn_chunk': 'the GoM basin', 'entity1_attnscore': 0.12, 'entity2_attnscore': 0.27, 'pair_attnscore': 0.17}), ('sea', 'We suggest that climate and tectonic perturbations in the upstream North American catchments can induce a substantial response in the downstream sectors of the Gulf Coastal Plain and ultimately in the GoM. This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca.', 'basin', {'entity1_score': 0.83, 'entity2_score': 1.0, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'the deep-sea fans', 'entity2_nn_chunk': 'the GoM basin', 'entity1_attnscore': 0.07, 'entity2_attnscore': 0.27, 'pair_attnscore': 0.11})], [('paleocene', 'This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca. 56 Ma) was a rapid global warming event characterized by the rise of temperatures to5–9 °C (Kennett and Stott, 1991), which caused substantial environmental changes around the globe.', 'eocene', {'entity1_score': 0.66, 'entity2_score': 1.0, 'entity1_label': 'B-GeoTime', 'entity2_label': 'B-GeoTime', 'entity1_nn_chunk': 'The Paleocene', 'entity2_nn_chunk': 'Eocene Thermal Maximum', 'entity1_attnscore': 0.15, 'entity2_attnscore': 0.58, 'pair_attnscore': 0.23}), ('paleocene', 'This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca. 56 Ma) was a rapid global warming event characterized by the rise of temperatures to5–9 °C (Kennett and Stott, 1991), which caused substantial environmental changes around the globe.', 'pet', {'entity1_score': 0.66, 'entity2_score': 0.64, 'entity1_label': 'B-GeoTime', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'The Paleocene', 'entity2_nn_chunk': '(PETM', 'entity1_attnscore': 0.15, 'entity2_attnscore': 0.18, 'pair_attnscore': 0.16}), ('eocene', 'This relationship is illustrated in the deep-water basin by (1) a high accommodation and deposition of a shale interval when coarse-grained terrigenous material was trapped upstream at the onset of the PETM, and (2) a considerable increase in sediment supply during the PETM, which is archived as a particularly thick sedimentary section in  the deep-sea fans of the GoM basin. The Paleocene–Eocene Thermal Maximum (PETM) (ca. 56 Ma) was a rapid global warming event characterized by the rise of temperatures to5–9 °C (Kennett and Stott, 1991), which caused substantial environmental changes around the globe.', 'pet', {'entity1_score': 1.0, 'entity2_score': 0.64, 'entity1_label': 'B-GeoTime', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'Eocene Thermal Maximum', 'entity2_nn_chunk': '(PETM', 'entity1_attnscore': 0.58, 'entity2_attnscore': 0.18, 'pair_attnscore': 0.27})], [('global', 'The Paleocene–Eocene Thermal Maximum (PETM) (ca. 56 Ma) was a rapid global warming event characterized by the rise of temperatures to5–9 °C (Kennett and Stott, 1991), which caused substantial environmental changes around the globe.', 'temperatures', {'entity1_score': 0.98, 'entity2_score': 0.91, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoMeth', 'entity1_nn_chunk': 'a rapid global warming event', 'entity2_nn_chunk': 'temperatures', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.86, 'pair_attnscore': 0.42}), ('global', 'The Paleocene–Eocene Thermal Maximum (PETM) (ca. 56 Ma) was a rapid global warming event characterized by the rise of temperatures to5–9 °C (Kennett and Stott, 1991), which caused substantial environmental changes around the globe.', 'kenn', {'entity1_score': 0.98, 'entity2_score': 0.97, 'entity1_label': 'B-GeoPetro', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'a rapid global warming event', 'entity2_nn_chunk': 'Kennett', 'entity1_attnscore': 0.27, 'entity2_attnscore': 0.09, 'pair_attnscore': 0.13}), ('temperatures', 'The Paleocene–Eocene Thermal Maximum (PETM) (ca. 56 Ma) was a rapid global warming event characterized by the rise of temperatures to5–9 °C (Kennett and Stott, 1991), which caused substantial environmental changes around the globe.', 'kenn', {'entity1_score': 0.91, 'entity2_score': 0.97, 'entity1_label': 'B-GeoMeth', 'entity2_label': 'B-GeoPetro', 'entity1_nn_chunk': 'temperatures', 'entity2_nn_chunk': 'Kennett', 'entity1_attnscore': 0.86, 'entity2_attnscore': 0.09, 'pair_attnscore': 0.16})]]
    count_entity_pairs = 36
    sentences = 5
    model_name = "botryan96/GeoBERT"  # Example model
    ner_model = NER_LLM.load_model(model_name, "NER")
    # ner_model = AutoModelForTokenClassification.from_pretrained(model_name, from_tf=True)
    print("11111111111")
    ner_tokenizer = AutoTokenizer.from_pretrained(model_name)
    print("11111111111")
    entity_embedding_extractor = EntityEmbeddingExtractor(ner_model, ner_tokenizer, count_entity_pairs,sentences)
    pairs_withemb = entity_embedding_extractor.extract_and_append_entity_embeddings(data)
if __name__ == "__main__":
    main()
